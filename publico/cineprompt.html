<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinePrompt AI - Gerador de Prompts de Vídeo</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">

    <style>
        body, h1, h2, h3, button, input, select, textarea { font-family: 'Inter', sans-serif; }
        .futuristic-background { background: #0a0a0a; background-image: radial-gradient(circle at center, rgba(168, 85, 247, 0.08), rgba(59, 130, 246, 0.05), transparent 70%); }
        .glass-effect { background-color: rgba(30, 41, 59, 0.3); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(71, 85, 105, 0.15); }
        .glass-effect-input-subtle { background-color: rgba(45, 55, 72, 0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(71, 85, 105, 0.15); }
        button, .button { transition: box-shadow 0.3s ease-in-out, transform 0.1s ease-out; cursor: pointer; }
        button:hover, .button:hover { transform: translateY(-1px); }
        .btn-purple { background-color: #9333ea; color: white; }
        .btn-purple:hover { background-color: #7e22ce; box-shadow: 0 0 10px rgba(168, 85, 247, 0.4), 0 0 15px rgba(168, 85, 247, 0.2); }
        .hidden { display: none; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal-content { padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #6b21a8; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes gradient-x {
            0%, 100% { background-size: 200% 200%; background-position: left center; }
            50% { background-size: 200% 200%; background-position: right center; }
        }
        .animate-gradient-x { animation: gradient-x 5s ease infinite; }
    </style>
</head>
<body class="futuristic-background text-gray-100">

    <div id="app-root">
        <div id="entry-page" class="min-h-screen bg-gray-950 text-gray-100 font-sans flex flex-col items-center justify-center p-4">
            <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover z-0" src="https://firebasestorage.googleapis.com/v0/b/platamais.firebasestorage.app/o/projeto%20vm%2FVIDEO%20CAPA%20NEO%20CINE%20PROMP.mp4?alt=media&token=a5037c56-def0-447d-8b22-5d18e7ec3e76" id="entry-video"></video>
            <div class="absolute inset-0 bg-black opacity-40 z-10"></div>
            <div class="text-center relative z-20">
                <img src="https://firebasestorage.googleapis.com/v0/b/platamais.firebasestorage.app/o/projeto%20vm%2Flogo%20conecta.png?alt=media&token=320f1061-918f-4bda-8585-c741efd227c1" alt="Logo Conecta" class="h-48 md:h-64 w-auto mx-auto mb-8" />
                <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-4">Bem-vindo ao <span class="bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent animate-gradient-x">CinePrompt AI</span></h1>
                <p class="text-xl md:text-2xl font-semibold mb-10">Sua Visão Grandiosa, Gerada com Inteligência.</p>
                <button id="enter-platform-btn" class="btn-purple font-bold py-4 px-12 rounded-lg text-xl shadow-lg border border-purple-500">
                    Entrar na Plataforma
                </button>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header id="app-header" class="bg-gray-900 p-4 shadow-lg glass-effect relative overflow-hidden min-h-[400px] flex flex-col justify-start">
                 <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover z-0" src="https://firebasestorage.googleapis.com/v0/b/platamais.firebasestorage.app/o/projeto%20vm%2FUntitled%20design.mp4?alt=media&token=623eef00-b722-4a64-8e27-b2bf831d5ebc" id="header-video"></video>
                 <div class="absolute inset-0 bg-black opacity-40 z-10"></div>
                 <div class="container mx-auto flex justify-between items-start relative z-20 pt-4">
                     <img src="https://firebasestorage.googleapis.com/v0/b/platamais.firebasestorage.app/o/projeto%20vm%2Flogo%20conecta.png?alt=media&token=320f1061-918f-4bda-8585-c741efd227c1" alt="Logo Conecta" class="h-16 w-auto" />
                     <nav id="main-nav" class="hidden md:flex items-center space-x-6"></nav>
                 </div>
            </header>
            
             <div class="w-full bg-gray-950 py-6 text-center border-b-2 border-purple-900 shadow-lg">
                <h2 class="text-2xl md:text-3xl font-extrabold text-white">Seu Prompt, <span class="bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">Obra Cinematográfica</span></h2>
                <p class="text-lg md:text-xl text-gray-300 mt-2">Sua Visão Grandiosa, Gerada com <span class="font-bold text-white">Inteligência.</span></p>
            </div>

            <main class="container mx-auto flex-grow p-4 md:p-8">
                <div class="lg:grid lg:grid-cols-2 lg:gap-8 flex flex-col">
                    <section id="controls-panel" class="p-6 rounded-xl shadow-lg mb-8 lg:mb-0 border border-purple-800 glass-effect"></section>
                    <section id="result-panel" class="p-6 rounded-xl shadow-lg flex flex-col border border-purple-800 glass-effect"></section>
                </div>
            </main>

            <footer class="bg-gray-900 p-4 text-center text-gray-400 text-sm border-t-2 border-purple-700 glass-effect">
                <span id="user-id-display"></span>
            </footer>
        </div>

        <div id="modal-container"></div>
        <div id="feedback-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[101]"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script type="module">
        // --- INICIALIZAÇÃO E CONFIGURAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBuB3dTMtejuuVMekhUVmzX343IG8zIzYg", // IMPORTANTE: Substitua pela sua chave de API
            authDomain: "platamais.firebaseapp.com",
            projectId: "platamais",
            storageBucket: "platamais.appspot.com",
            messagingSenderId: "1014260724484",
            appId: "1:1014260724484:web:b6c3216ea4641714291651"
        };
        
        let app, db, auth;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = "<h1>Erro Crítico: Não foi possível conectar ao Firebase. Verifique a configuração e as chaves de API.</h1>";
        }

        // --- CONSTANTES ---
        const appId = 'default-app-id'; // Defina um ID para seu app se necessário
        const videoStyleOptions = ['Realista', 'Anime', 'Cinematográfico', 'Futurista', 'Documentário', 'Animação 2D', 'Stop Motion', 'VFX', 'Fantasia Épica', 'Ficção Científica Clássica', 'Noir', 'Comédia Romântica', 'Terror Psicológico', 'Ação Dinâmica', 'Drama Histórico', 'Musical Vibrante', 'Cyberpunk', 'Steampunk', 'Vintage (Anos 80/90)'];
        const defaultCameraTypeOptions = ['Travelling lento', 'Drone sobrevoando', 'POV (Ponto de Vista)', 'Plano sequência', 'Zoom in/out', 'Câmara fixa', 'Handheld', 'Panorâmica', 'Tilt', 'POV (Personagem)', 'Grande Angular', 'Close-up Extremo', 'Câmera Lenta (Slow Motion)', 'Time-lapse', 'Câmera no Ombro', 'Estabilizada (Gimbal)', 'Subaquática', 'Aérea (Helicóptero)', 'Visão Noturna', 'Olho de Peixe'];
        const lightingOptions = ['Luz natural dourada', 'Neon vibrante', 'Sombra dramática', 'Luz suave difusa', 'Flash estroboscópico', 'Luz de velas', 'Contraluz', 'Luz ambiente', 'Luz de palco', 'Luz de rua (úmida)', 'Amanhecer/Crepúsculo', 'Luz de Fogueira', 'Reflexos de Água', 'Luz de Tempestade', 'Luz de Monitor (computador)'];
        const colorPaletteOptions = ['Tons pastéis', 'Cores vibrantes', 'Monocromático', 'Cores quentes', 'Cores frias', 'Sépia', 'Preto e Branco', 'Cores Complementares', 'Tons Terrosos', 'Cores Metálicas', 'Gradiente Suave', 'Cores Neons (saturadas)', 'Tons Jóia', 'Paleta Desbotada (Vintage)', 'Cores Primárias Fortes'];
        const formatOptions = ['16:9 (Paisagem)', '9:16 (Vertical/TikTok)', '1:1 (Quadrado)', '4:3 (Clássico)'];
        const outputLanguageOptions = [{id: 'portuguese', name: 'Português'}, {id: 'english', name: 'Inglês'}];
        const voiceNarrationOptions = ["Zephyr", "Puck", "Charon", "Kore", "Fenrir", "Leda", "Orus", "Aoede", "Callirrhoe", "Autonoe", "Enceladus", "Iapetus", "Umbriel", "Algieba", "Despina", "Erinome", "Algenib", "Rasalgethi", "Laomedeia", "Achernar", "Alnilam", "Schedar", "Gacrux", "Pulcherrima", "Achird", "Zubenelgenubi", "Vindemiatrix", "Sadachbia", "Sadaltager", "Sulafat", "Sem Narração"];

        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            isAuthReady: false,
            userId: null,
            isUserLoggedIn: false,
            userEmail: '',
            userPrompts: [],
            userCharacters: [],
            userStories: [],
            userCustomCameraTypes: [],
            
            // Formulário principal
            videoStyle: '', theme: '', narrative: '', selectedCharacters: [], cameraType: '', lighting: '',
            colorPalette: '', duration: 10, format: '', quality: '', outputLanguage: 'portuguese', voiceNarration: '',

            // UI
            isLoadingPrompt: false,
            generatedPrompt: '',
            activeModal: null, // 'characters', 'stories', 'camera', 'auth', 'profile', 'plans', 'confirmation'
            
            // Gerenciadores
            editingCharacter: null,
            newCharacterName: '', newCharacterDescription: '', newCharacterVisuals: '', newCharacterPersonality: '',
            
            editingCameraType: null,
            newCameraTypeName: '',
        };

        // --- ELEMENTOS DO DOM ---
        const entryPage = document.getElementById('entry-page');
        const mainApp = document.getElementById('main-app');
        const enterPlatformBtn = document.getElementById('enter-platform-btn');
        const controlsPanel = document.getElementById('controls-panel');
        const resultPanel = document.getElementById('result-panel');
        const modalContainer = document.getElementById('modal-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const mainNav = document.getElementById('main-nav');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        
        function render() {
            if (entryPage.classList.contains('hidden')) {
                mainNav.innerHTML = getNavHTML();
                controlsPanel.innerHTML = getControlsHTML();
                resultPanel.innerHTML = getResultHTML();
                userIdDisplay.textContent = state.userId ? `ID do Usuário: ${state.userId}` : '';
                
                if (state.activeModal) {
                    modalContainer.innerHTML = getModalHTML(state.activeModal);
                } else {
                    modalContainer.innerHTML = '';
                }
                
                attachEventListeners();
                lucide.createIcons();
            }
        }
        
        function getNavHTML() {
            const loggedInMenu = `
                <button data-action="open-modal" data-modal="characters" class="text-gray-300 hover:text-purple-400 transition-colors duration-200 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-1"></i> Meus Personagens</button>
                <button data-action="open-modal" data-modal="camera" class="text-gray-300 hover:text-purple-400 transition-colors duration-200 flex items-center"><i data-lucide="camera" class="w-4 h-4 mr-1"></i> Tipos de Câmera</button>
                <button data-action="open-modal" data-modal="plans" class="text-gray-300 hover:text-purple-400 transition-colors duration-200 flex items-center"><i data-lucide="dollar-sign" class="w-4 h-4 mr-1"></i> Planos</button>
                <button data-action="open-modal" data-modal="profile" class="text-gray-300 hover:text-purple-400 transition-colors duration-200 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-1"></i> Perfil</button>
                <button data-action="logout" class="text-gray-300 hover:text-red-400 transition-colors duration-200 flex items-center"><i data-lucide="log-out" class="w-4 h-4 mr-1"></i> Sair</button>
            `;
            const loggedOutMenu = `
                <button data-action="open-modal" data-modal="auth" class="btn-purple font-bold py-2 px-4 rounded-lg flex items-center"><i data-lucide="log-in" class="w-4 h-4 mr-2"></i> Login / Cadastro</button>
            `;
            return state.isUserLoggedIn ? loggedInMenu : loggedOutMenu;
        }

        function getControlsHTML() {
            const allCameraOptions = [...defaultCameraTypeOptions, ...state.userCustomCameraTypes.map(c => c.name)];
            return `
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center"><i data-lucide="sparkles" class="mr-2 text-purple-300"></i> Crie Seu Prompt de Vídeo</h2>
                <form id="prompt-form" onsubmit="return false;">
                    <div class="grid md:grid-cols-2 gap-4">
                        ${createSelectHTML('Estilo do Vídeo', 'videoStyle', videoStyleOptions, state.videoStyle, 'film')}
                        ${createSelectHTML('Formato', 'format', formatOptions, state.format, 'crop')}
                    </div>
                    ${createInputHTML('text', 'Tema ou Ambiente', 'theme', state.theme, 'Ex: Floresta mística...', 'building')}
                    ${createTextAreaHTML('Narrativa', 'narrative', state.narrative, 'Ex: Um explorador encontra...', 'edit')}
                     <div class="mb-4">
                        <label class="block text-gray-300 text-sm font-bold mb-2 flex items-center"><i data-lucide="users" class="mr-2 text-purple-400"></i> Personagens</label>
                        <select id="selectedCharacters" multiple class="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 bg-gray-700 text-gray-100 h-32 overflow-y-auto">
                            ${state.userCharacters.map(c => `<option value="${c.id}" ${state.selectedCharacters.includes(c.id) ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                        <button type="button" data-action="open-modal" data-modal="characters" class="mt-2 bg-gray-700 hover:bg-gray-600 text-gray-200 text-sm py-2 px-4 rounded-lg"><i data-lucide="plus-circle" class="inline mr-2 w-4 h-4"></i> Gerenciar Personagens</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        ${createSelectHTML('Tipo de Câmera', 'cameraType', allCameraOptions, state.cameraType, 'camera')}
                        ${createSelectHTML('Iluminação', 'lighting', lightingOptions, state.lighting, 'lightbulb')}
                        ${createSelectHTML('Paleta de Cores', 'colorPalette', colorPaletteOptions, state.colorPalette, 'palette')}
                        ${createInputHTML('text', 'Qualidade e Detalhes', 'quality', state.quality, 'Ex: 4K, fotorrealista...', 'sparkles')}
                    </div>
                     <div class="mb-4">
                        <label class="block text-gray-300 text-sm font-bold mb-2 flex items-center"><i data-lucide="clock" class="mr-2 text-purple-400"></i> Duração (segundos)</label>
                        <div class="flex items-center space-x-3">
                            <input type="range" id="duration" min="1" max="60" step="1" value="${state.duration}" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                            <input type="number" value="${state.duration}" class="w-20 shadow appearance-none border border-gray-600 rounded-lg py-2 px-3 bg-gray-700" readonly>
                        </div>
                    </div>
                     <div class="grid md:grid-cols-2 gap-4">
                        ${createSelectHTML('Idioma do Prompt', 'outputLanguage', outputLanguageOptions.map(o => ({value: o.id, text: o.name})), state.outputLanguage, 'languages')}
                        ${createSelectHTML('Voz da Narração', 'voiceNarration', voiceNarrationOptions, state.voiceNarration, 'mic')}
                    </div>
                </form>
            `;
        }
        
        function getResultHTML() {
            return `
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center"><i data-lucide="sparkles" class="mr-2 text-purple-300"></i> Resultado do Prompt</h2>
                <div class="flex-grow relative">
                    <textarea id="generated-prompt" readonly class="w-full h-full min-h-[250px] bg-gray-800 bg-opacity-80 text-gray-100 font-mono p-4 rounded-lg resize-none border border-gray-600">${state.isLoadingPrompt ? 'Gerando...' : state.generatedPrompt}</textarea>
                     ${state.isLoadingPrompt ? `<div class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 rounded-lg"><i data-lucide="loader-2" class="animate-spin text-purple-400 h-12 w-12"></i></div>` : ''}
                </div>
                 <div class="mt-6 flex flex-wrap gap-2 justify-center">
                    <button data-action="generate" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center disabled:opacity-50" ${state.isLoadingPrompt ? 'disabled' : ''}>
                         ${state.isLoadingPrompt ? '<i data-lucide="loader-2" class="mr-2 w-5 h-5 animate-spin"></i> Gerando...' : '<i data-lucide="sparkles" class="mr-2 w-5 h-5"></i> Gerar com IA'}
                    </button>
                    <button data-action="copy" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i data-lucide="copy" class="mr-2 w-5 h-5"></i> Copiar</button>
                    ${state.isUserLoggedIn ? `<button data-action="save" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i data-lucide="save" class="mr-2 w-5 h-5"></i> Salvar</button>` : ''}
                    <button data-action="reset" class="bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg flex items-center"><i data-lucide="rotate-ccw" class="mr-2 w-5 h-5"></i> Limpar</button>
                </div>
            `;
        }

        function getModalHTML(modalType) {
            // ... (Implemente a lógica para retornar o HTML de cada modal: auth, characters, etc.)
            // Por exemplo, para o modal de personagens:
            if (modalType === 'characters') {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content bg-gray-800 w-full max-w-2xl glass-effect">
                            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                                <h2 class="text-2xl font-bold text-purple-400 flex items-center"><i data-lucide="users" class="mr-2"></i> Meus Personagens</h2>
                                <button data-action="close-modal"><i data-lucide="x" class="w-7 h-7 text-gray-400"></i></button>
                            </div>
                            <div class="mb-8 p-4 border border-gray-700 rounded-lg glass-effect-input-subtle">
                                <h3 class="text-xl font-semibold text-gray-200 mb-4">${state.editingCharacter ? 'Editar' : 'Adicionar'} Personagem</h3>
                                <form id="character-form">
                                   ${createInputHTML('text', 'Nome', 'newCharacterName', state.newCharacterName, 'Ex: Capitão Estelar', 'type')}
                                   ${createTextAreaHTML('Descrição', 'newCharacterDescription', state.newCharacterDescription, 'Ex: Um líder corajoso...')}
                                   ${createTextAreaHTML('Traços Visuais', 'newCharacterVisuals', state.newCharacterVisuals, 'Ex: Armadura azul...')}
                                   ${createTextAreaHTML('Personalidade', 'newCharacterPersonality', state.newCharacterPersonality, 'Ex: Determinado...')}
                                   <button type="submit" class="mt-4 btn-purple font-bold py-2 px-4 rounded-lg">${state.editingCharacter ? 'Atualizar' : 'Salvar'}</button>
                                </form>
                            </div>
                            <div class="space-y-4">
                                ${state.userCharacters.map(char => `
                                    <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg text-purple-300">${char.name}</p>
                                            <p class="text-sm text-gray-300 mt-1">${char.description}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button data-action="edit-character" data-id="${char.id}" class="p-2 rounded-full bg-blue-600"><i data-lucide="pen-square" class="w-4 h-4"></i></button>
                                            <button data-action="delete-character" data-id="${char.id}" data-name="${char.name}" class="p-2 rounded-full bg-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
             if (modalType === 'auth') {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content bg-gray-800 w-full max-w-sm glass-effect">
                             <div class="flex justify-between items-center mb-6">
                               <h2 id="auth-title" class="text-2xl font-bold text-purple-400">Login</h2>
                               <button data-action="close-modal"><i data-lucide="x" class="w-7 h-7 text-gray-400"></i></button>
                            </div>
                            <form id="auth-form">
                                ${createInputHTML('email', 'Email', 'authEmail', '', 'seu@email.com', 'mail')}
                                ${createInputHTML('password', 'Senha', 'authPassword', '', '********', 'lock')}
                                <div id="auth-error" class="text-red-400 text-center my-2"></div>
                                <button type="submit" id="auth-submit-btn" class="w-full btn-purple font-bold py-2 px-4 rounded-lg">Entrar</button>
                            </form>
                            <button id="google-signin-btn" class="w-full bg-white text-gray-800 font-bold py-2 px-4 rounded-lg mt-4 flex items-center justify-center">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-2"> Entrar com Google
                            </button>
                            <p class="text-center text-sm text-gray-400 mt-4">
                               <span id="auth-toggle-text">Não tem conta?</span>
                               <button data-action="toggle-auth-mode" class="font-medium text-blue-400 hover:underline" id="auth-toggle-btn">Cadastre-se</button>
                            </p>
                        </div>
                    </div>
                `;
            }
            // ... (Implemente os outros modais de forma similar)
            return ''; // Retorna string vazia se o tipo de modal for desconhecido
        }
        
        // --- FUNÇÕES AUXILIARES DE RENDERIZAÇÃO ---
        function createInputHTML(type, label, id, value, placeholder, icon) {
             return `<div class="mb-4"><label for="${id}" class="block text-gray-300 text-sm font-bold mb-2 flex items-center"><i data-lucide="${icon}" class="w-4 h-4 mr-2 text-purple-400"></i> ${label}</label><input type="${type}" id="${id}" value="${value}" placeholder="${placeholder}" class="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 bg-gray-700 text-gray-100"></div>`;
        }
        function createTextAreaHTML(label, id, value, placeholder, icon) {
            return `<div class="mb-4"><label for="${id}" class="block text-gray-300 text-sm font-bold mb-2 flex items-center"><i data-lucide="${icon}" class="w-4 h-4 mr-2 text-purple-400"></i> ${label}</label><textarea id="${id}" placeholder="${placeholder}" class="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 bg-gray-700 text-gray-100 h-24">${value}</textarea></div>`;
        }
        function createSelectHTML(label, id, options, selectedValue, icon) {
            const optionsHTML = options.map(opt => {
                const value = typeof opt === 'object' ? opt.value : opt;
                const text = typeof opt === 'object' ? opt.text : opt;
                return `<option value="${value}" ${value === selectedValue ? 'selected' : ''}>${text}</option>`;
            }).join('');
            return `<div class="mb-4"><label for="${id}" class="block text-gray-300 text-sm font-bold mb-2 flex items-center"><i data-lucide="${icon}" class="w-4 h-4 mr-2 text-purple-400"></i> ${label}</label><select id="${id}" class="shadow appearance-none border border-gray-600 rounded-lg w-full py-2 px-3 bg-gray-700 text-gray-100">${optionsHTML}</select></div>`;
        }
        
        // --- FUNÇÕES DE LÓGICA E EVENTOS ---
        function attachEventListeners() {
            // Formulário principal
            const form = document.getElementById('prompt-form');
            if (form) {
                form.addEventListener('input', (e) => {
                    if (state.hasOwnProperty(e.target.id)) {
                        state[e.target.id] = e.target.id === 'duration' ? Number(e.target.value) : e.target.value;
                         if (e.target.id === 'duration' && e.target.type === 'range') {
                            const numberInput = form.querySelector('input[type="number"]');
                            if(numberInput) numberInput.value = e.target.value;
                        }
                    }
                });
                const charactersSelect = document.getElementById('selectedCharacters');
                if(charactersSelect) {
                    charactersSelect.addEventListener('change', () => {
                        state.selectedCharacters = Array.from(charactersSelect.selectedOptions).map(opt => opt.value);
                    });
                }
            }
            
            // Botões de ação e navegação
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                const modalType = target.dataset.modal;

                if (action === 'open-modal') {
                    state.activeModal = modalType;
                    render();
                } else if (action === 'close-modal') {
                    state.activeModal = null;
                    render();
                } else if (action === 'generate') {
                    // ... chamar a função de gerar prompt
                } else if (action === 'copy') {
                    // ... chamar a função de copiar
                } else if (action === 'save') {
                    // ... chamar a função de salvar
                } else if (action === 'reset') {
                    // ... chamar a função de resetar
                } else if (action === 'logout') {
                    signOut(auth);
                } else if (action === 'toggle-auth-mode') {
                    // ... lógica para alternar entre login e cadastro
                }
                 // ... outros actions
            });
            
            // Listeners específicos de modais
            if (state.activeModal === 'characters') {
                 document.getElementById('character-form').addEventListener('submit', handleSaveCharacter);
            }
             if (state.activeModal === 'auth') {
                 document.getElementById('auth-form').addEventListener('submit', handleAuthAction);
                 document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            }
        }
        
        // ... (Implemente todas as funções de handlers: handleSaveCharacter, handleAuthAction, generatePromptWithAI, etc.)
        // Lembre-se que, ao final de cada handler que modifica o estado, você deve chamar `render()` para atualizar a UI.

        function handleSaveCharacter(e) {
            e.preventDefault();
            const name = document.getElementById('newCharacterName').value;
            // ... (pegar outros valores)
            // ... (lógica do firestore para salvar/atualizar)
            // ... no final:
            state.activeModal = null; // ou talvez manter o modal aberto e só limpar o form
            render();
        }
        
        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        enterPlatformBtn.addEventListener('click', () => {
            entryPage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            render();
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                state.userId = user.uid;
                state.isUserLoggedIn = !user.isAnonymous;
                state.userEmail = user.email || 'Anônimo';
                // Iniciar listeners do Firestore aqui
                setupFirestoreListeners(user.uid);
            } else {
                signInAnonymously(auth).catch(console.error);
                state.userId = null;
                state.isUserLoggedIn = false;
                state.userEmail = '';
            }
            state.isAuthReady = true;
            render();
        });

        function setupFirestoreListeners(uid) {
            const charactersRef = firebase.firestore().collection(`artifacts/${appId}/users/${uid}/characters`);
            charactersRef.onSnapshot(snapshot => {
                state.userCharacters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            // ... outros listeners
        }
    </script>
</body>
</html>